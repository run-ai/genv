<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enforcement &mdash; genv 0.4.0 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Overview" href="../remote/overview.html" />
    <link rel="prev" title="Advanced Usage" href="advanced-usage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> genv
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="advanced-usage.html">Advanced Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Enforcement</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quickstart">Quickstart</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#non-environment-processes">Non-environment Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#max-devices-per-user">Max Devices per User</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#permissions">Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enforcement-rules">Enforcement Rules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Non-environment Processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Max Devices per User</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Remote Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../remote/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../remote/enforcement.html">Enforcement</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../development/reference.html">Reference</a></li>
</ul>
<p class="caption"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about/changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">genv</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Enforcement</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/usage/enforcement.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="enforcement">
<span id="id1"></span><h1>Enforcement<a class="headerlink" href="#enforcement" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#enforcement" id="id8">Enforcement</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id9">Overview</a></p></li>
<li><p><a class="reference internal" href="#quickstart" id="id10">Quickstart</a></p>
<ul>
<li><p><a class="reference internal" href="#non-environment-processes" id="id11">Non-environment Processes</a></p></li>
<li><p><a class="reference internal" href="#max-devices-per-user" id="id12">Max Devices per User</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#permissions" id="id13">Permissions</a></p></li>
<li><p><a class="reference internal" href="#architecture" id="id14">Architecture</a></p></li>
<li><p><a class="reference internal" href="#enforcement-rules" id="id15">Enforcement Rules</a></p>
<ul>
<li><p><a class="reference internal" href="#id4" id="id16">Non-environment Processes</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id17">Max Devices per User</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="id6">
<img alt="../_images/enforcement-overview1.png" src="../_images/enforcement-overview1.png" />
<p class="caption"><span class="caption-text">Genv enforcement overview</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<p>Genv provisions the GPU resources on a machine by attaching devices to environments.</p>
<p>It takes into account the available hardware as well as the environment configuration.
In the future, the usage in real time will also be taken into account for optimal decisions.</p>
<p>The provisioned resources are then bookkept in <a class="reference internal" href="../development/reference.html#files"><span class="std std-ref">state files</span></a> for as long as the environments are active or the resources are released, by detaching devices for example.</p>
<p>After provisioning the resources, Genv helps environments to use only their granted resources by manipulating the shell environment and by executing <a class="reference internal" href="../development/reference.html#shims"><span class="std std-ref">shims</span></a>.</p>
<p>However, all processes still technically have access to all devices and all their resources such as GPU memory, because these are bare-metal processes and not containers.</p>
<p>Genv supports enforcement features to allow users and system administrators to ensure that only the resources provisioned by Genv are being used by processes and environments using the command <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span></code>.</p>
</div>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>This is a guide to get started with enforcement features in Genv.</p>
<p>Follow this tutorial and run the commands on a GPU machine with Genv installed.</p>
<p>You will need a GPU consuming application.
This could be Python code that uses TensorFlow, PyTorch, or any other application that you have.
We will be using a CUDA application called <code class="code docutils literal notranslate"><span class="pre">quickstart</span></code>.</p>
<p>We will go over two <a class="reference internal" href="#enforcement-rules"><span class="std std-ref">enforcement logics</span></a> in this tutorial.</p>
<div class="section" id="non-environment-processes">
<h3>Non-environment Processes<a class="headerlink" href="#non-environment-processes" title="Permalink to this headline">¶</a></h3>
<p>Open a terminal on your GPU machine and run the application in the background:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ./quickstart <span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="m">63600</span>
</pre></div>
</div>
<p>We can make sure that the application is indeed using GPU resources with <code class="code docutils literal notranslate"><span class="pre">nvidia-smi</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ nvidia-smi
...
+-----------------------------------------------------------------------------+
<span class="p">|</span> Processes:                                                                  <span class="p">|</span>
<span class="p">|</span>  GPU   GI   CI        PID   Type   Process name                  GPU Memory <span class="p">|</span>
<span class="p">|</span>        ID   ID                                                   Usage      <span class="p">|</span>
<span class="p">|</span><span class="o">=============================================================================</span><span class="p">|</span>
<span class="p">|</span>    <span class="m">0</span>   N/A  N/A     <span class="m">63600</span>      C   ./quickstart                     7295MiB <span class="p">|</span>
+-----------------------------------------------------------------------------+
</pre></div>
</div>
<p>Now, we will run a <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span></code> command and ask it to terminate processes that are not running within environments.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ genv enforce --interval <span class="m">0</span> --non-env-processes
Process <span class="m">63600</span> is not running in a GPU environment
Terminating process <span class="m">63600</span> from environment N/A that is running on GPU<span class="o">(</span>s<span class="o">)</span> <span class="m">0</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span>+  Terminated              ./quickstart
</pre></div>
</div>
<p>You can see that the process was terminated.
You can also verify it by running <code class="code docutils literal notranslate"><span class="pre">nvidia-smi</span></code> once again.</p>
<p>If you will activate an environment with attached devices (you can run <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">activate</span> <span class="pre">--gpus</span> <span class="pre">1</span></code>) and rerun all steps, you will see that now the process does not get terminated.</p>
</div>
<div class="section" id="max-devices-per-user">
<h3>Max Devices per User<a class="headerlink" href="#max-devices-per-user" title="Permalink to this headline">¶</a></h3>
<p>Activate an environment and attach a device to it:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ genv activate --gpus <span class="m">1</span>
</pre></div>
</div>
<p>Let’s verify that the environment is active and is attached to a device using <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">devices</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ genv devices
ID      ENV ID      ENV NAME        ATTACHED
<span class="m">0</span>       <span class="m">67609</span>                       <span class="m">42</span> seconds ago
</pre></div>
</div>
<p>Now run the application in the background as before:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ./quickstart <span class="p">&amp;</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span> <span class="m">67708</span>
</pre></div>
</div>
<p>Now, we will run another <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span></code> command.
To start, we will allow each user to use one device.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ genv enforce --interval <span class="m">0</span> --max-devices-per-user <span class="m">1</span>
</pre></div>
</div>
<p>We can see that nothing happened as we are using a single device which is allowed.</p>
<p>Let’s rerun the command, but this time allow zero devices to be used:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ genv enforce --interval <span class="m">0</span> --max-devices-per-user <span class="m">0</span>
User raz is using <span class="m">1</span> devices which is <span class="m">1</span> more than the maximum allowed
Terminating process <span class="m">67708</span> from environment <span class="m">67609</span> that is running on GPU<span class="o">(</span>s<span class="o">)</span> <span class="m">0</span>
Detaching environment <span class="m">67609</span> of user raz from device <span class="m">0</span>
<span class="o">[</span><span class="m">1</span><span class="o">]</span>+  Terminated              ./quickstart
</pre></div>
</div>
<p>You can see that the process was terminated and the environment was detached from the device.</p>
<p>To make sure the devices was detached from the environment, you can run <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">devices</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ genv devices
ID      ENV ID      ENV NAME        ATTACHED
<span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="permissions">
<h2>Permissions<a class="headerlink" href="#permissions" title="Permalink to this headline">¶</a></h2>
<p>As described later on in the <a class="reference internal" href="#architecture"><span class="std std-ref">architecture</span></a> section, Genv both detaches environments from devices and terminates running processes.</p>
<p>Detaching environments from devices is done by modifying the <code class="code docutils literal notranslate"><span class="pre">devices.json</span></code> <a class="reference internal" href="../development/reference.html#files"><span class="std std-ref">file</span></a>.
Because of how Genv creates these state files, all Linux users have access to modify them, hence all Linux users have permissions to detach environments of any Linux user.</p>
<p>On the other hand, Linux users usually can’t terminate processes of other users or query their environment variables.
Therefore, you will probably need to execute the <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span></code> commands <a class="reference internal" href="advanced-usage.html#using-sudo"><span class="std std-ref">using</span></a> <code class="code docutils literal notranslate"><span class="pre">sudo</span></code> with a command similar to the following:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>sudo <span class="k">$(</span>which genv<span class="k">)</span> enforce ...
</pre></div>
</div>
</div>
<div class="section" id="architecture">
<span id="id2"></span><h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>The command <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span></code> acts as a foreground daemon, that is running in a while-loop, and executes an enforcement cycle every once in a while.</p>
<div class="figure align-default" id="id7">
<img alt="../_images/enforcement-cycle1.png" src="../_images/enforcement-cycle1.png" />
<p class="caption"><span class="caption-text">Genv enforcement cycle</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</div>
<p>Every cycle, Genv takes a snapshot of all the provisioned resources as well as the running GPU compute processes in real time by executing <code class="code docutils literal notranslate"><span class="pre">nvidia-smi</span></code> commands.</p>
<p>Then, Genv goes over the snapshot and runs different enforcement logics.
Every enforcement logic is responsible for one enforcement rule and checks if it is violated.</p>
<p>After running all enforcement logics, Genv combines all the conclusions and continues to the execution phase.</p>
<p>In the execution phase, it terminates running processes and detaches environments from devices according to the findings.
Running processes from environments on the devices that are being detached are also terminated.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Genv enforcer terminates only the GPU processes.
This means that IDEs (e.g. Visual Studio Code, PyCharm, etc.) and terminals will not be terminated, but the running task processes such as <code class="code docutils literal notranslate"><span class="pre">python</span></code> processes or Jupyter kernels.</p>
</div>
</div>
<div class="section" id="enforcement-rules">
<span id="id3"></span><h2>Enforcement Rules<a class="headerlink" href="#enforcement-rules" title="Permalink to this headline">¶</a></h2>
<p>Enforcement rules are controlled using flags and arguments to <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span></code>.
You can also run <code class="code docutils literal notranslate"><span class="pre">genv</span> <span class="pre">enforce</span> <span class="pre">--help</span></code> to see all other supported flags and features.</p>
<div class="section" id="id4">
<h3>Non-environment Processes<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Use the flag <code class="code docutils literal notranslate"><span class="pre">--non-env-processes</span></code> to terminate running processes that access a GPU and are not running within an environment.</p>
<p>This is mostly used for ensuring that no one runs GPU applications that are not managed by Genv on a machine.</p>
<p>This ensures that Genv is the only way that GPU resources are being provisioned in the system.</p>
</div>
<div class="section" id="id5">
<h3>Max Devices per User<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>Use the flag <code class="code docutils literal notranslate"><span class="pre">--max-devices-per-user</span> <span class="pre">&lt;value&gt;</span></code> to control how many devices each Linux user can access.</p>
<p>If a Linux user is using more devices than the specified value, some of his or her environments would get detached to free up resources.
Processes from the detached environments that are running on the detached devices would get terminated.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="advanced-usage.html" class="btn btn-neutral float-left" title="Advanced Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../remote/overview.html" class="btn btn-neutral float-right" title="Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Run.ai.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>